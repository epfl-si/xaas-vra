layout:
  pages:
  - id: page_deployment_properties
    title: Deployment
    sections:
    - id: section_DEBUG_D
      fields:
      - id: DEBUG_D
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_project
      fields:
      - id: project
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: projectName
        display: textField
        state:
          visible: false
          read-only: true
        signpostPosition: right-middle
      - id: projectId
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_deploymentNameHash
      fields:
      - id: deploymentNameHash
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_D: true
          read-only: true
        signpostPosition: right-middle
    - id: section_deploymentName
      fields:
      - id: deploymentName
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_D: true
          read-only: true
        signpostPosition: right-middle
    - id: section_dplyName
      fields:
      - id: dplyName
        display: textField
        state:
          visible: true
        signpostPosition: right-middle
    - id: section_description
      fields:
      - id: description
        display: textArea
        state:
          visible:
          - value: true
            equals:
              DEBUG_D: true
          read-only: true
        signpostPosition: right-middle
    - id: section_dplyDescription
      fields:
      - id: dplyDescription
        display: textArea
        state:
          read-only: false
          visible: true
        signpostPosition: right-middle
    - id: section_reasonsForRequest
      fields:
      - id: reasonsForRequest
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_requestor
      fields:
      - id: requestor
        display: textField
        state:
          read-only: true
          visible: true
        signpostPosition: right-middle
    - id: section_deploymentTag
      fields:
      - id: deploymentTag
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_notificationMail
      fields:
      - id: notificationMail
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_funding
      fields:
      - id: funding
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_fnsPrjName
      fields:
      - id: fnsPrjName
        display: textField
        state:
          visible:
          - value: true
            equals:
              funding: fns
          read-only: false
        signpostPosition: right-middle
      - id: fnsPrjNo
        display: textField
        state:
          visible:
          - value: true
            equals:
              funding: fns
          read-only: false
        signpostPosition: right-middle
    state: { }
  - id: page_volume_properties
    title: 'Volume '
    sections:
    - id: section_DEBUG_V
      fields:
      - id: DEBUG_V
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_deletionPolicy
      fields:
      - id: deletionPolicy
        display: dropDown
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: false
        signpostPosition: right-middle
    - id: section_volType
      fields:
      - id: volType
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    - id: section_sizeGB
      fields:
      - id: sizeGB
        display: textField
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_minSnapPercent
      fields:
      - id: minSnapPercent
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: false
        signpostPosition: right-middle
    - id: section_snapPolicy
      fields:
      - id: snapPolicy
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: snapPercent
        display: dropDown
        state:
          visible:
          - value: true
            notEqual:
              snapPolicy: none
          read-only: false
        signpostPosition: right-middle
    - id: section_price
      fields:
      - id: price
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_svm
      fields:
      - id: svm
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_access
      fields:
      - id: access
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_IPsRoot
      fields:
      - id: IPsRoot
        display: textArea
        state:
          visible:
          - value: true
            equals:
              access: nfs3
          - value: true
            equals:
              DEBUG_V: true
          read-only: false
        signpostPosition: right-middle
      - id: xfix_IPsRoot
        display: textField
        state:
          visible:
          - value: true
            equals:
              access: nfs3
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle

    - id: section_IPsRO
      fields:
      - id: IPsRO
        display: textArea
        state:
          visible:
          - value: true
            equals:
              access: nfs3
          - value: true
            equals:
              DEBUG_V: true
          read-only: false
        signpostPosition: right-middle
      - id: xfix_IPsRO
        display: textField
        state:
          visible:
          - value: true
            equals:
              access: nfs3
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle

    - id: section_IPsRW
      fields:
      - id: IPsRW
        display: textArea
        state:
          visible:
          - value: true
            equals:
              access: nfs3
          - value: true
            equals:
              DEBUG_V: true
          read-only: false
        signpostPosition: right-middle
      - id: xfix_IPsRW
        display: textField
        state:
          visible:
          - value: true
            equals:
              access: nfs3
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    state: { }
schema:
  # deployment
  DEBUG_D:
    label: DEBUG (D)
    type:
      dataType: boolean
    default: false
    constraints: { }
  deletionPolicy:
    label: Deletion Policy
    type:
      dataType: string
      isMultiple: false
    default: outboard
    valueList:
    - label: delete
      value: delete
    - label: outboard
      value: outboard
    constraints:
      required: true
  deploymentNameHash:
    label: deploymentNameHash
    type:
      dataType: string
    default:
      id: ch.epfl.iaas.js/randomHash
      type: scriptAction
      parameters:
      - s3: '``'
        $type:
          dataType: string
          isMultiple: false
      - s4: '``'
        $type:
          dataType: string
          isMultiple: false
      - s5: '``'
        $type:
          dataType: string
          isMultiple: false
      - s1: '``'
        $type:
          dataType: string
          isMultiple: false
      - s2: '``'
        $type:
          dataType: string
          isMultiple: false
    placeholder: ''
    constraints: { }
  deploymentName:
    label: (tmp) Deployment Name
    type:
      dataType: string
      isMultiple: false
    default:
      bind:
        values:
        - sizeGB
        - '`GB volume for `'
        - projectName
        - '` [`'
        - deploymentNameHash
        - '`]`'
        operator: concatenate
    constraints:
      required: true
      max-value: 80
  deploymentTag:
    label: Environment
    type:
      dataType: string
      isMultiple: false
    default: Test
    valueList:
    - label: Development
      value: Development
    - label: Test
      value: Test
    - label: Production
      value: Production
    constraints:
      required: true
  description:
    label: (tmp) Description
    type:
      dataType: string
      isMultiple: false
    default:
      bind: dplyDescription
    constraints:
      required: true
      max-value: 256
  dplyName:
    label: Deployment Name
    type:
      dataType: string
      isMultiple: false
    constraints:
      required: true
  dplyDescription:
    label: Description
    type:
      dataType: string
    constraints:
      required: true
      max-value: 256
  notificationMail:
    label: Notification Mail
    signpost: |-
      EPFL email addresses only, one email per line.
      Supports groups mail addresses defined on http://groups.epfl.ch 
      Emails must be visible in LDAP.
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.ad/getUserMailFromVRAUserPrincipalName
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        userPrincipalName: _requestedBy
    constraints:
      required: true
  project:
    label: Project
    type:
      dataType: string
      isMultiple: false
    valueList:
      id: projects
      type: scriptAction
    constraints:
      required: true
  projectName:
    label: Project Name
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.name`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints:
      required: true
  projectId:
    label: Project Id
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.id`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints:
      required: true
  reasonsForRequest:
    label: Reasons for request
    type:
      dataType: string
    placeholder: ''
    constraints:
      required: true
  requestor:
    label: Requestor
    type:
      dataType: string
      isMultiple: false
    default:
      bind: _requestedBy
    constraints:
      required: true

  # deployment - funding
  fnsPrjName:
    label: FNS Project Name
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required:
      - value: true
        equals:
          funding: fns
  fnsPrjNo:
    label: FNS Project Number
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required:
      - value: true
        equals:
          funding: fns
  funding:
    label: Funding
    type:
      dataType: string
    default: epfl
    valueList:
    - label: EPFL
      value: epfl
    - label: FNS
      value: fns
    placeholder: ''
    constraints:
      required: true

  # volume - general
  DEBUG_V:
    label: DEBUG (V)
    type:
      dataType: boolean
    default: false
    constraints: { }
  volType:
    label: Volume Type
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.nas/getVolType
      type: scriptAction
      parameters: [ ]
  sizeGB:
    label: Volume Size (GB)
    type:
      dataType: string
      isMultiple: false
    default: '10'
    constraints:
      pattern:
        value: ^[0-9]*$
        message: Volume Size must be a number

  # volume - access
  access:
    label: Access
    type:
      dataType: string
      isMultiple: false
    default: cifs
    valueList:
    - label: CIFS
      value: cifs
    - label: NFSv3
      value: nfs3
    constraints:
      required: true
  IPsRoot:
    label: Root Access Policy
    signpost: |-
      Several entries allowed, one with IP per line, using the following format :
      <li> &lt;IP&gt; (e.g. 128.178.200.200)
      <li> &lt;IP&gt;/&lt;netmask&gt; (e.g. 128.178.200.0/255.255.255.0)
      <li> &lt;IP&gt;/&lt;cidr&gt;  (e.g. 128.178.200.0/24)
    type:
      dataType: string
      isMultiple: false
    constraints: { }
  xfix_IPsRoot:
    label: xfix_IPsRoot
    type:
      dataType: string
      isMultiple: false
    default:
      bind: IPsRoot
    constraints: { }
  IPsRO:
    label: RO Access Policy
    signpost: |-
      Several entries allowed, one with IP per line, using the following format :
      <li> &lt;IP&gt; (e.g. 128.178.200.200)
      <li> &lt;IP&gt;/&lt;netmask&gt; (e.g. 128.178.200.0/255.255.255.0)
      <li> &lt;IP&gt;/&lt;cidr&gt;  (e.g. 128.178.200.0/24)
    type:
      dataType: string
      isMultiple: false
    constraints: { }
  xfix_IPsRO:
    label: xfix_IPsRO
    type:
      dataType: string
      isMultiple: false
    default:
      bind: IPsRW
    constraints: { }
  IPsRW:
    label: RW Access Policy
    signpost: |-
      Several entries allowed, one with IP per line, using the following format :
      <li> &lt;IP&gt; (e.g. 128.178.200.200)
      <li> &lt;IP&gt;/&lt;netmask&gt; (e.g. 128.178.200.0/255.255.255.0)
      <li> &lt;IP&gt;/&lt;cidr&gt;  (e.g. 128.178.200.0/24)
    type:
      dataType: string
      isMultiple: false
    constraints: { }
  xfix_IPsRW:
    label: xfix_IPsRW
    type:
      dataType: string
      isMultiple: false
    default:
      bind: IPsRW
    constraints: { }

  # volume - specific col part
  svm:
    label: SVM
    type:
      dataType: string
      isMultiple: false
    valueList:
      id: ch.epfl.xaas.nas/getSvmList
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        projectId: projectId
    constraints:
      required: true
  snapPolicy:
    label: Snapshot Policy
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.config/getDefaultValue
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        deploymentTag: deploymentTag
      - $type:
          dataType: string
          isMultiple: false
        elementName: '`XaasNas_snapshot_policies_EPFL`'
      - $type:
          dataType: string
          isMultiple: false
        projectName: projectName
    valueList:
      id: ch.epfl.config/getList
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        deploymentTag: deploymentTag
      - $type:
          dataType: string
          isMultiple: false
        elementName: '`XaasNas_snapshot_policies_EPFL`'
      - $type:
          dataType: string
          isMultiple: false
        projectName: projectName
    constraints:
      required: true
  minSnapPercent:
    label: minSnapPercent
    type:
      dataType: string
    default:
    - value: '0'
      equals:
        snapPolicy: none
    - value: '5'
      notEqual:
        snapPolicy: none
    placeholder: ''
    constraints: { }
  snapPercent:
    label: Snapshot Percent
    type:
      dataType: string
      isMultiple: false
    default:
      bind: minSnapPercent
    valueList:
      id: ch.epfl.xaas.nas/getSnapPercentList
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        initValue: minSnapPercent
    constraints: { }

  # volume - price
  price:
    label: Price
    type:
      dataType: string
    default:
      id: ch.epfl.xaas.nas/getPrice
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '``'
      - $type:
          dataType: string
          isMultiple: false
        sizeGB: sizeGB
      - $type:
          dataType: string
          isMultiple: false
        snapPercent: snapPercent
    placeholder: ''
    constraints: { }

options:
  externalValidations:
  - label: Notification mail check
    source:
      id: ch.epfl.iaas.utils.mail/checkMails
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        mails: notificationMail
    target:
    - notificationMail
  - label: Check volume name availability
    source:
      id: ch.epfl.xaas.nas/colVolAvailable
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        access: access
      - $type:
          dataType: string
          isMultiple: false
        projectId: projectId
    target:
    - projectName
  - label: Root Access Policy Check
    source:
      id: ch.epfl.xaas.nas/checkIP
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        IPs: xfix_IPsRoot
    target:
    - IPsRoot
  - label: RO Access Policy Check
    source:
      id: ch.epfl.xaas.nas/checkIP
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        IPs: xfix_IPsRO
    target:
    - IPsRO
  - label: RW Access Policy Check
    source:
      id: ch.epfl.xaas.nas/checkIP
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        IPs: xfix_IPsRW
    target:
    - IPsRW
