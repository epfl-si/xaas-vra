layout:
  pages:
  - id: page_general
    sections:
    - id: section_DEBUG_G
      fields:
      - id: DEBUG_G
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_volName
      fields:
      - id: volName
        display: textField
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_onboardStatus
      fields:
      - id: onboardStatus
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    title: General
    state: {}
  - id: page_deployment_properties
    title: Deployment
    sections:
    - id: section_DEBUG_D
      fields:
      - id: DEBUG_D
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_project
      fields:
      - id: project
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: projectName
        display: textField
        state:
          visible: false
          read-only: true
        signpostPosition: right-middle
      - id: projectId
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_deploymentName
      fields:
      - id: deploymentName
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_D: true
          read-only: true
        signpostPosition: right-middle
    - id: section_dplyName
      fields:
      - id: dplyName
        display: textField
        state:
          visible: true
        signpostPosition: right-middle
    - id: section_description
      fields:
      - id: description
        display: textArea
        state:
          visible:
          - value: true
            equals:
              DEBUG_D: true
          read-only: true
        signpostPosition: right-middle
    - id: section_dplyDescription
      fields:
      - id: dplyDescription
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_reasonsForRequest
      fields:
      - id: reasonsForRequest
        display: textArea
        state:
          visible: false
          read-only: false
        signpostPosition: right-middle
    - id: section_requestor
      fields:
      - id: requestor
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_env
      fields:
      - id: env
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_notificationMail
      fields:
      - id: notificationMail
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_funding
      fields:
        - id: funding
          display: dropDown
          state:
            visible: true
            read-only: false
          signpostPosition: right-middle
    - id: section_fnsPrjName
      fields:
        - id: fnsPrjName
          display: textField
          state:
            visible:
              - value: true
                equals:
                  funding: fns
            read-only: false
          signpostPosition: right-middle
        - id: fnsPrjNo
          display: textField
          state:
            visible:
              - value: true
                equals:
                  funding: fns
            read-only: false
          signpostPosition: right-middle
    state:
      visible:
      - value: true
        equals:
          onboardStatus: Ok
  - id: page_volume_properties
    sections:
    - id: section_checkbox_DEBUG_V
      fields:
      - id: DEBUG_V
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_volType
      fields:
        - id: volType
          display: textField
          state:
            visible:
              - value: true
                equals:
                  DEBUG_V: true
            read-only: true
          signpostPosition: right-middle
    - id: section_volName_V
      fields:
      - id: volName_V
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_volId
      fields:
      - id: volId
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    - id: section_sizeGB
      fields:
      - id: sizeGB
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_snapPolicy
      fields:
        - id: snapPolicy
          display: textField
          state:
            visible: true
            read-only: true
          signpostPosition: right-middle
        - id: snapPercent
          display: textField
          state:
            visible:
              - value: true
                notEqual:
                  snapPolicy: none
            read-only: true
          signpostPosition: right-middle
    - id: section_price
      fields:
        - id: price
          display: textField
          state:
            visible: true
            read-only: true
          signpostPosition: right-middle
    - id: section_svm
      fields:
      - id: svm
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_mountPath
      fields:
      - id: mountPath
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_access
      fields:
      - id: access
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_IPsRoot
      fields:
      - id: IPsRoot
        display: textArea
        state:
          visible:
          - value: true
            equals:
              volType: app
          - value: true
            equals:
              access: nfs3
          read-only: true
        signpostPosition: right-middle
    - id: section_IPsRO
      fields:
      - id: IPsRO
        display: textArea
        state:
          visible:
          - value: true
            equals:
              volType: app
          - value: true
            equals:
              access: nfs3
          read-only: true
        signpostPosition: right-middle
    - id: section_IPsRW
      fields:
      - id: IPsRW
        display: textArea
        state:
          visible:
          - value: true
            equals:
              volType: app
          - value: true
            equals:
              access: nfs3
          read-only: true
        signpostPosition: right-middle
    title: Volume
    state:
      visible:
      - value: true
        equals:
          onboardStatus: Ok
schema:
  # general panel
  DEBUG_G:
    label: DEBUG (G)
    type:
      dataType: boolean
    default: true
    constraints: {}
  volName:
    label: Volume Name
    signpost: |- 
      Enter the name of the volume to be onboarded. It must be
      <li> present in the backend </li>
      <li> not already onboarded</li>
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints: {}
  onboardStatus:
    label: Status
    signpost: Volume cannot be onboarded yet
    type:
      dataType: string
    default:
      id: ch.epfl.xaas.nas/readyToOnboardMsg
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        volName: volName
    placeholder: ''
    constraints:
      pattern:
        value: ^Ok$
        message: ''
      required: true

  # deployment
  DEBUG_D:
    label: DEBUG (D)
    type:
      dataType: boolean
    default: false
    constraints: {}
  deploymentName:
    label: (tmp) Deployment Name
    type:
      dataType: string
      isMultiple: false
    default:
      bind: dplyName
    constraints:
      required: true
      max-value: 80
  env:
    label: Environment
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.jsonconfig/getDefaultValue
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        projectName: projectName
      - env: '``'
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        jsonConfigName: '`environments`'
    valueList:
      id: ch.epfl.iaas.jsonconfig/getList
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        projectName: projectName
      - $type:
          dataType: string
          isMultiple: false
        env: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonConfigName: '`environments`'
    constraints:
      required: true
  description:
    label: (tmp) Description
    type:
      dataType: string
      isMultiple: false
    default:
      bind: dplyDescription
    constraints:
      required: true
      max-value: 256
  dplyDescription:
    label: Description
    type:
      dataType: string
    constraints:
      required: true
      max-value: 256
  dplyName:
    label: Deployment Name
    type:
      dataType: string
      isMultiple: false
    constraints:
      required: true
  notificationMail:
    label: Notification Mail
    signpost: |-
      EPFL email addresses only, one email per line.
      Supports groups mail addresses defined on http://groups.epfl.ch 
      Emails must be visible in LDAP.
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.nas/getNotificationMailForOnboarding
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          requestor: _requestedBy
        - $type:
            dataType: string
            isMultiple: false
          volName: volName
    constraints:
      required: true
  project:
    label: Project
    type:
      dataType: string
      isMultiple: false
    valueList:
      id: projects
      type: scriptAction
    constraints:
      required: true
  projectName:
    label: Project Name
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.name`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints: {}
  projectId:
    label: Project Id
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.id`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints: {}
  reasonsForRequest:
    label: Reason for request
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints: {}
  requestor:
    label: Requestor
    type:
      dataType: string
      isMultiple: false
    default:
      bind: _requestedBy
    constraints: {}

  # deployment - funding
  fnsPrjName:
    label: FNS Project Name
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required:
        - value: true
          equals:
            funding: fns
  fnsPrjNo:
    label: FNS Project Number
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required:
        - value: true
          equals:
            funding: fns
  funding:
    label: Funding
    type:
      dataType: string
    default: epfl
    valueList:
      - label: EPFL
        value: epfl
      - label: FNS
        value: fns
    placeholder: ''
    constraints:
      required: true

  # volume - general
  DEBUG_V:
    label: DEBUG (V)
    type:
      dataType: boolean
    default: false
    constraints: {}
  volName_V:
    label: Volume Name
    type:
      dataType: string
    default:
      bind: volName
    placeholder: ''
    constraints: {}
  volId:
    label: Volume Id
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`volume.uuid`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: volName
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasNas`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'
    constraints:
      required: true
  volType:
    label: Volume Type
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`volume.type`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: volName
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasNas`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'
    constraints: {}
  sizeGB:
    label: Volume Size (GB)
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`size.user.sizeGB`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: volName
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasNas`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'

  # volume - access
  access:
    label: Access
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          jsonPath: '`access.protocol`'
        - $type:
            dataType: string
            isMultiple: false
          filterValue: '``'
        - dtId: volName
          $type:
            dataType: string
            isMultiple: false
        - $type:
            dataType: string
            isMultiple: false
          targetTenant: '``'
        - $type:
            dataType: string
            isMultiple: false
          dtName: '`XaasNas`'
        - $type:
            dataType: string
            isMultiple: false
          filterField: '``'
        - $type:
            dataType: string
            isMultiple: false
          jsonSubPath: '``'
    constraints: {}
  IPsRoot:
    label: Root Access Policy
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsMultilineString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`access.rules.Root`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: volName
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasNas`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'
  IPsRO:
    label: RO Access Policy
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsMultilineString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`access.rules.RO`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: volName
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasNas`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'
  IPsRW:
    label: RW Access Policy
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsMultilineString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`access.rules.RW`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: volName
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasNas`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'
  mountPath:
    label: Mount Path
    type:
      dataType: string
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          jsonPath: '`access.rootMountPath`'
        - $type:
            dataType: string
            isMultiple: false
          filterValue: '``'
        - dtId: volName
          $type:
            dataType: string
            isMultiple: false
        - $type:
            dataType: string
            isMultiple: false
          targetTenant: '``'
        - $type:
            dataType: string
            isMultiple: false
          dtName: '`XaasNas`'
        - $type:
            dataType: string
            isMultiple: false
          filterField: '``'
        - $type:
            dataType: string
            isMultiple: false
          jsonSubPath: '``'
    placeholder: ''
    constraints: {}
  svm:
    label: SVM
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          jsonPath: '`access.svm`'
        - $type:
            dataType: string
            isMultiple: false
          filterValue: '``'
        - dtId: volName
          $type:
            dataType: string
            isMultiple: false
        - $type:
            dataType: string
            isMultiple: false
          targetTenant: '``'
        - $type:
            dataType: string
            isMultiple: false
          dtName: '`XaasNas`'
        - $type:
            dataType: string
            isMultiple: false
          filterField: '``'
        - $type:
            dataType: string
            isMultiple: false
          jsonSubPath: '``'
    constraints: {}


  # volume - specific col part
  snapPolicy:
    label: Snapshot Policy
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          jsonPath: '`snapshots.policy`'
        - $type:
            dataType: string
            isMultiple: false
          filterValue: '``'
        - dtId: volName
          $type:
            dataType: string
            isMultiple: false
        - $type:
            dataType: string
            isMultiple: false
          targetTenant: '``'
        - $type:
            dataType: string
            isMultiple: false
          dtName: '`XaasNas`'
        - $type:
            dataType: string
            isMultiple: false
          filterField: '``'
        - $type:
            dataType: string
            isMultiple: false
          jsonSubPath: '``'
    constraints: {}
  snapPercent:
    label: Snapshot Percent
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          jsonPath: '`snapshots.reservePercent`'
        - $type:
            dataType: string
            isMultiple: false
          filterValue: '``'
        - dtId: volName
          $type:
            dataType: string
            isMultiple: false
        - $type:
            dataType: string
            isMultiple: false
          targetTenant: '``'
        - $type:
            dataType: string
            isMultiple: false
          dtName: '`XaasNas`'
        - $type:
            dataType: string
            isMultiple: false
          filterField: '``'
        - $type:
            dataType: string
            isMultiple: false
          jsonSubPath: '``'

  # volume - price
  price:
    label: Price
    type:
      dataType: string
    default:
      id: ch.epfl.xaas.nas/getPrice
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          jsonPath: '``'
        - $type:
            dataType: string
            isMultiple: false
          sizeGB: sizeGB
        - $type:
            dataType: string
            isMultiple: false
          snapPercent: snapPercent
    placeholder: ''
    constraints: { }

options:
  externalValidations:
  - label: Check notification mail
    source:
      id: ch.epfl.iaas.utils.mail/checkMails
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        mails: notificationMail
    target:
    - notificationMail
