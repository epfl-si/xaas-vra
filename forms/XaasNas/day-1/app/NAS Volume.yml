layout:
  pages:
  - id: page_deployment_properties
    title: Deployment
    sections:
    - id: section_DEBUG_D
      fields:
      - id: DEBUG_D
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_deploymentNameHash
      fields:
        - id: deploymentNameHash
          display: textField
          state:
            visible:
              - value: true
                equals:
                  DEBUG_D: true
            read-only: true
          signpostPosition: right-middle
    - id: section_deploymentName
      fields:
        - id: deploymentName
          display: textField
          state:
            visible:
              - value: true
                equals:
                  DEBUG_D: true
            read-only: true
          signpostPosition: right-middle
    - id: section_dplyName
      fields:
        - id: dplyName
          display: textField
          state:
            visible: true
          signpostPosition: right-middle
    - id: section_description
      fields:
        - id: description
          display: textArea
          state:
            visible:
              - value: true
                equals:
                  DEBUG_D: true
            read-only: true
          signpostPosition: right-middle
    - id: section_dplyDescription
      fields:
        - id: dplyDescription
          display: textArea
          state:
            visible: true
            read-only: false
          signpostPosition: right-middle
    - id: section_project
      fields:
      - id: project
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: projectName
        display: textField
        state:
          visible: false
          read-only: true
        signpostPosition: right-middle
      - id: projectId
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_reasonsForRequest
      fields:
      - id: reasonsForRequest
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_requestor
      fields:
      - id: requestor
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_deploymentTag
      fields:
      - id: deploymentTag
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_notificationMail
      fields:
      - id: notificationMail
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    state: {}
  - id: page_volume_properties
    title: Volume
    sections:
    - id: section_DEBUG_V
      fields:
      - id: DEBUG_V
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_deletionPolicy
      fields:
      - id: deletionPolicy
        display: dropDown
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: false
        signpostPosition: right-middle
    - id: section_volType
      fields:
      - id: volType
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    - id: section_volName
      fields:
      - id: volName
        display: textField
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_sizeGB
      fields:
      - id: sizeGB
        display: textField
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_access
      fields:
      - id: access
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_IPsRoot
      fields:
      - id: IPsRoot
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: xfix_IPsRoot
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    - id: section_IPsRO
      fields:
      - id: IPsRO
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: xfix_IPsRO
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    - id: section_IPsRW
      fields:
      - id: IPsRW
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: xfix_IPsRW
        display: textField
        state:
          visible:
          - value: true
            equals:
              DEBUG_V: true
          read-only: true
        signpostPosition: right-middle
    state: {}
schema:
  # deployment
  DEBUG_D:
    label: DEBUG (D)
    type:
      dataType: boolean
    default: false
    constraints: {}
  deletionPolicy:
    label: Deletion Policy
    type:
      dataType: string
      isMultiple: false
    default: outboard
    valueList:
      - label: delete
        value: delete
      - label: outboard
        value: outboard
    constraints:
      required: true
  deploymentNameHash:
    label: deploymentNameHash
    type:
      dataType: string
    default:
      id: ch.epfl.iaas.js/randomHash
      type: scriptAction
      parameters:
        - s3: '``'
          $type:
            dataType: string
            isMultiple: false
        - s4: '``'
          $type:
            dataType: string
            isMultiple: false
        - s5: '``'
          $type:
            dataType: string
            isMultiple: false
        - s1: '``'
          $type:
            dataType: string
            isMultiple: false
        - s2: '``'
          $type:
            dataType: string
            isMultiple: false
    placeholder: ''
    constraints: {}
  deploymentName:
    label: (tmp) Deployment Name
    type:
      dataType: string
      isMultiple: false
    default:
      bind:
        values:
          - sizeGB
          - '`GB volume for `'
          - projectName
          - '` [`'
          - deploymentNameHash
          - '`]`'
        operator: concatenate
    constraints:
      required: true
      max-value: 80
  deploymentTag:
    label: Environment
    type:
      dataType: string
      isMultiple: false
    default: Test
    valueList:
      - label: Development
        value: Development
      - label: Test
        value: Test
      - label: Production
        value: Production
    constraints:
      required: true
  description:
    label: (tmp) Description
    type:
      dataType: string
      isMultiple: false
    default:
      bind: dplyDescription
    constraints:
      required: true
      max-value: 256
  dplyDescription:
    label: Description
    type:
      dataType: string
    constraints:
      required: true
      max-value: 256
  dplyName:
    label: Deployment Name
    type:
      dataType: string
      isMultiple: false
    constraints:
      required: true
  notificationMail:
    label: Notification Mail
    signpost: List of valid EPFL emails separated by whitespace or newline.
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.ad/getUserMailFromVRAUserPrincipalName
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          userPrincipalName: _requestedBy
    constraints:
      required: true
  project:
    label: Project
    type:
      dataType: string
      isMultiple: false
    valueList:
      id: projects
      type: scriptAction
    constraints:
      required: true
  projectName:
    label: Project Name
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.name`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints:
      required: true
  projectId:
    label: Project Id
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.id`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints:
      required: true
  reasonsForRequest:
    label: Reasons for request
    type:
      dataType: string
    placeholder: ''
    constraints:
      required: true
  requestor:
    label: Requestor
    type:
      dataType: string
      isMultiple: false
    default:
      bind: _requestedBy
    constraints:
      required: true

  # volume - general
  DEBUG_V:
    label: DEBUG (V)
    type:
      dataType: boolean
    default: false
    constraints: { }
  volType:
    label: Volume Type
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.nas/getVolType
      type: scriptAction
      parameters: []
  volName:
    label: Volume Name
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required: true
  sizeGB:
    label: Volume Size (GB)
    type:
      dataType: string
      isMultiple: false
    default: '10'
    constraints:
      pattern:
        value: ^[0-9]*$
        message: Volume Size must be a number

  # volume - access
  access:
    label: Access
    type:
      dataType: string
      isMultiple: false
    default: cifs
    valueList:
    - label: CIFS
      value: cifs
    - label: NFSv3
      value: nfs3
    constraints:
      required: true
  IPsRoot:
    label: Root Access Policy
    type:
      dataType: string
      isMultiple: false
    constraints: {}
  IPsRO:
    label: RO Access Policy
    type:
      dataType: string
      isMultiple: false
    constraints: {}
  IPsRW:
    label: RW Access Policy
    type:
      dataType: string
      isMultiple: false
  xfix_IPsRoot:
    label: xfix_IPsRoot
    type:
      dataType: string
      isMultiple: false
    default:
      bind: IPsRoot
    constraints: { }
  xfix_IPsRO:
    label: xfix_IPsRO
    type:
      dataType: string
      isMultiple: false
    default:
      bind: IPsRW
    constraints: { }
  xfix_IPsRW:
    label: xfix_IPsRW
    type:
      dataType: string
      isMultiple: false
    default:
      bind: IPsRW
    constraints: { }

options:
  externalValidations:
  - label: Notification mail check
    source:
      id: ch.epfl.iaas.utils.mail/checkMails
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        mails: notificationMail
    target:
    - notificationMail
  - label: Check volume name availability
    source:
      id: ch.epfl.xaas.nas/appVolAvailable
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        volName: volName
      - $type:
          dataType: string
          isMultiple: false
        projectId: projectId
    target:
    - volName
  - label: Root Access Policy Check
    source:
      id: ch.epfl.xaas.nas/checkIP
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        IPs: xfix_IPsRoot
    target:
    - IPsRoot
  - label: RO Access Policy Check
    source:
      id: ch.epfl.xaas.nas/checkIP
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        IPs: xfix_IPsRO
    target:
    - IPsRO
  - label: RW Access Policy Check
    source:
      id: ch.epfl.xaas.nas/checkIP
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        IPs: xfix_IPsRW
    target:
    - IPsRW
