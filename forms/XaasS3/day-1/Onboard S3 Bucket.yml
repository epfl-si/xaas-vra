layout:
  pages:
  - id: page_general
    title: General
    sections:
    - id: section_DEBUG_G
      fields:
      - id: DEBUG_G
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_bucketName
      fields:
      - id: name
        display: textField
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_onboardStatus
      fields:
      - id: onboardStatus
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    state: {}

  - id: page_deployment_properties
    title: Deployment
    sections:
    - id: section_DEBUG_D
      fields:
      - id: DEBUG_D
        display: checkbox
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_project
      fields:
      - id: project
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
      - id: projectName
        display: textField
        state:
          visible: false
          read-only: true
        signpostPosition: right-middle
      - id: projectId
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_deploymentName
      fields:
        - id: deploymentName
          display: textField
          state:
            visible:
              - value: true
                equals:
                  DEBUG_D: true
            read-only: true
          signpostPosition: right-middle
    - id: section_dplyName
      fields:
        - id: dplyName
          display: textField
          state:
            visible: true
          signpostPosition: right-middle
    - id: section_description
      fields:
        - id: description
          display: textArea
          state:
            visible:
              - value: true
                equals:
                  DEBUG_D: true
            read-only: true
          signpostPosition: right-middle
    - id: section_dplyDescription
      fields:
        - id: dplyDescription
          display: textArea
          state:
            visible: true
            read-only: false
          signpostPosition: right-middle
    - id: section_reasonsForRequest
      fields:
      - id: reasonsForRequest
        display: textArea
        state:
          visible: false
          read-only: false
        signpostPosition: right-middle
    - id: section_requestor
      fields:
      - id: requestor
        display: textField
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    - id: section_env
      fields:
      - id: env
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_notificationMail
      fields:
      - id: notificationMail
        display: textArea
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_hasFunding
      fields:
      - id: hasFunding
        display: checkbox
        state:
          visible:
          - value: true
            equals:
              DEBUG_D: true
          read-only: true
        signpostPosition: right-middle
    - id: section_funding
      fields:
      - id: funding
        display: dropDown
        state:
          visible:
          - value: true
            equals:
              hasFunding: true
          read-only: false
        signpostPosition: right-middle
    - id: section_fnsPrjName
      fields:
      - id: fnsPrjName
        display: textField
        state:
          visible:
          - value: true
            equals:
              funding: fns
          read-only: false
        signpostPosition: right-middle
      - id: fnsPrjNo
        display: textField
        state:
          visible:
          - value: true
            equals:
              funding: fns
          read-only: false
        signpostPosition: right-middle
    state: {}
  - id: page_bucket_properties
    title: Bucket
    sections:
    - id: section_linkedTo
      fields:
      - id: linkedTo
        display: dropDown
        state:
          visible: true
          read-only: false
        signpostPosition: right-middle
    - id: section_versioning
      fields:
      - id: versioning
        display: dropDown
        state:
          visible: true
          read-only: true
        signpostPosition: right-middle
    state: {}
schema:
  # onboarding - general
  DEBUG_G:
    label: DEBUG (G)
    type:
      dataType: boolean
    default: true
    constraints: {}
  name:
    label: Bucket Name
    signpost: |- 
      Enter the name of the bucket to be onboarded. It must be
      <li> present in the backend </li>
      <li> not already onboarded</li>
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints: {}
  onboardStatus:
    label: Status
    signpost: Bucket cannot be onboarded yet
    type:
      dataType: string
    default:
      id: ch.epfl.xaas.s3/readyToOnboardMsg
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        bucketName: name
    placeholder: ''
    constraints:
      pattern:
        value: ^Ok$
        message: ''
      required: true

  # deployment - general
  DEBUG_D:
    label: DEBUG (D)
    type:
      dataType: boolean
    default: true
    constraints: {}
  deploymentName:
    label: (tmp) Deployment Name
    type:
      dataType: string
      isMultiple: false
    default:
      bind: dplyName
    constraints:
      required: true
      max-value: 80
  env:
    label: Environment
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.jsonconfig/getDefaultValue
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        projectName: projectName
      - env: '``'
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        jsonConfigName: '`environments`'
    valueList:
      id: ch.epfl.iaas.jsonconfig/getList
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        projectName: projectName
      - $type:
          dataType: string
          isMultiple: false
        env: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonConfigName: '`environments`'
    constraints:
      required: true
  description:
    label: (tmp) Description
    type:
      dataType: string
      isMultiple: false
    default:
      bind: dplyDescription
    constraints:
      required: true
      max-value: 256
  dplyDescription:
    label: Description
    type:
      dataType: string
    constraints:
      required: true
      max-value: 256
  dplyName:
    label: Deployment Name
    type:
      dataType: string
      isMultiple: false
    constraints:
      required: true
  notificationMail:
    label: Notification Mail
    signpost: |-
      EPFL email addresses only, one email per line.
      Supports groups mail addresses defined on http://groups.epfl.ch 
      Emails must be visible in LDAP.
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils.mail/getUserEmailFromVRAUserPrincipalName
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          userPrincipalName: _requestedBy
    constraints:
      required: true
  project:
    label: Project
    type:
      dataType: string
      isMultiple: false
    valueList:
      id: projects
      type: scriptAction
    constraints:
      required: true
  projectName:
    label: Project name
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.name`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
  projectId:
    label: Project Id
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.iaas.utils/getProjectCPfromId
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        cpName: '`ch.epfl.vra.project.id`'
      - $type:
          dataType: string
          isMultiple: false
        projectId: project
    constraints: {}
  reasonsForRequest:
    label: Reason for request
    type:
      dataType: string
      isMultiple: false
    default: '`Bucket onboarded w/o approval`'
    constraints:
      required: true
  requestor:
    label: Requestor
    type:
      dataType: string
      isMultiple: false
    default:
      bind: _requestedBy
    constraints: {}

  # deployment - funding
  fnsPrjName:
    label: FNS Project Name
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required:
      - value: true
        equals:
          funding: fns
  fnsPrjNo:
    label: FNS Project Number
    type:
      dataType: string
      isMultiple: false
    default: ''
    constraints:
      required:
      - value: true
        equals:
          funding: fns
  funding:
    label: Funding
    type:
      dataType: string
    default: epfl
    valueList:
      - label: EPFL
        value: epfl
      - label: FNS
        value: fns
    placeholder: ''
    constraints:
      required: true
  hasFunding:
    label: Has Funding?
    type:
      dataType: boolean
    default:
      id: ch.epfl.xaas.utils/hasFunding
      type: scriptAction
      parameters:
        - $type:
            dataType: string
            isMultiple: false
          namespace: '`XaasS3`'

  # bucket information
  linkedTo:
    label: Linked to
    type:
      dataType: string
      isMultiple: false
    valueList:
      id: ch.epfl.xaas.s3/getBucketsToLink
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        projectId: projectId
    constraints: {}
  versioning:
    label: Versioning?
    signpost: |-
      A bucket with versioning protects against object deletion and overwrites, but can also impact the total capacity consumed:
      <li> when <font color="red"><i>active</i></font> all new objects will be versionined and previously versioned objects will be retained.
      <li>when <font color="red"><i>suspened</i></font> new objects will not be versioned but previously versions will be retained,
    type:
      dataType: string
      isMultiple: false
    default:
      id: ch.epfl.xaas.customform.cache/getCacheInfoFldAsString
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        jsonPath: '`versioning.status`'
      - $type:
          dataType: string
          isMultiple: false
        filterValue: '``'
      - dtId: name
        $type:
          dataType: string
          isMultiple: false
      - $type:
          dataType: string
          isMultiple: false
        targetTenant: '``'
      - $type:
          dataType: string
          isMultiple: false
        dtName: '`XaasS3`'
      - $type:
          dataType: string
          isMultiple: false
        filterField: '``'
      - $type:
          dataType: string
          isMultiple: false
        jsonSubPath: '``'
    constraints: {}

options:
  externalValidations:
  - label: Check notification mail
    source:
      id: ch.epfl.iaas.utils.mail/checkMails
      type: scriptAction
      parameters:
      - $type:
          dataType: string
          isMultiple: false
        mails: notificationMail
    target:
    - notificationMail
